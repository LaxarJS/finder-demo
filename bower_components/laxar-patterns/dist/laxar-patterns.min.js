/** Copyright 2015 aixigo AG, Released under the MIT license: http://laxarjs.org/license */
define("laxar-patterns/lib/actions",["laxar"],function(a){"use strict";function b(b,d,e){var f=a.object.path(b.features,d+".action",null);return c(b,f,e)}function c(b,c,d){a.assert(b).hasType(Object).hasProperty("eventBus"),a.assert(c).hasType(String).isNotNull();var e=a.object.options(d,{deliverToSender:!1,onSuccess:i,onError:i,onComplete:i});a.assert(e.onSuccess).hasType(Function).isNotNull(),a.assert(e.onError).hasType(Function).isNotNull(),a.assert(e.onComplete).hasType(Function).isNotNull();var f={deliverToSender:e.deliverToSender};return e.timeout>0&&(f.pendingDidTimeout=e.timeout),function(d){var g=a.object.options(d,{action:c});return b.eventBus.publishAndGatherReplies("takeActionRequest."+c,g,f).then(function(a){var b=a.some(function(a){return a.event.outcome===l});if(e.onComplete(a.slice(0)),b)throw e.onError(a.slice(0)),a;return e.onSuccess(a.slice(0)),a})}}function d(b){return a.assert(b).hasType(Object).hasProperty("eventBus"),new e(b)}function e(a){this.scope_=a}function f(b,c,d,e,f){b.publish("willTakeAction."+c,{action:c},j);var i,m={action:c,outcome:k};try{i=d(e,f)}catch(n){throw m.outcome=l,b.publish("didTakeAction."+c+"."+l,m,j),n}h().when(i).then(function(a){return g(a)&&(m.outcome=a.outcome===l?l:k),a},function(a){return m.outcome=l,g(a)&&(m.outcome=a.outcome===k?k:l),a}).then(function(d){m=a.object.options(m,d);var e="didTakeAction."+c+"."+m.outcome;b.publish(e,m,j)})}function g(a){return null!==a&&"object"==typeof a}function h(){return a._tooling.provideQ()}var i=function(){},j={deliverToSender:!1},k="SUCCESS",l="ERROR";return e.prototype.registerActionsFromFeature=function(b,c){var d=a.object.path(this.scope_.features,b+".onActions")||[];return this.registerActions(d,c)},e.prototype.registerActions=function(b,c){a.assert(b).hasType(Array).isNotNull(),a.assert(c).hasType(Function).isNotNull();var d=this;return b.forEach(function(a){d.scope_.eventBus.subscribe("takeActionRequest."+a,function(b,e){f(d.scope_.eventBus,a,c,b,e)})}),this},{publisher:c,publisherForFeature:b,handlerFor:d,OUTCOME_ERROR:l,OUTCOME_SUCCESS:k}}),define("laxar-patterns/lib/errors",["laxar"],function(a){"use strict";function b(b,d,e){c(b).hasType(Object).isNotNull(),c(b.eventBus).hasType(Object).isNotNull(),c(e).hasType(Object);var f=e&&e.localizer;c(f).hasType(Function);var g=a.object.path(b.features,d);return c(g).hasType(Object).isNotNull(),function(d,e,h,i){var j=a.object.path(g,e);c(j).isNotNull(),h=h||{},b.eventBus.publish("didEncounterError."+d,{code:d,message:a.string.format(f?f(j):j,[],h),data:h,cause:i||{}},{deliverToSender:!1})}}var c=a.assert;return{errorPublisherForFeature:b}}),define("laxar-patterns/lib/flags",["laxar"],function(a){"use strict";function b(a){return new c(a)}function c(a){this.scope_=a}function d(a){if(!a)return[];var b=Array.isArray(a)?a:[a];return b.map(function(a){var b=0===a.indexOf("!");return{name:b?a.substr(1):a,negated:b,state:b}})}function e(a){if(!a)return function(){};var b=Array.isArray(a)?a:[a];return function(a,c){b.forEach(function(b){b(a,c)})}}function f(a,b){var c=a.reduce(g[b],null);return null===c?!1:c}c.prototype.registerFlagFromFeature=function(b,c){return this.registerFlag(a.object.path(this.scope_.features,b,[]),c)},c.prototype.registerFlag=function(b,c){c=a.object.options(c,{predicate:"any"});var g=function(){};"scopeKey"in c&&(g=function(b){a.object.setPath(this.scope_,c.scopeKey,b)}.bind(this));var h=d(b),i=e(c.onChange),j="boolean"==typeof c.initialState?c.initialState:f(h,c.predicate);return g(j),h.forEach(function(a){this.scope_.eventBus.subscribe("didChangeFlag."+a.name,function(b){a.state=a.negated?!b.state:b.state;var d=f(h,c.predicate);d!==j&&(g(d),i(d,j),j=d)}.bind(this))}.bind(this)),this};var g={any:function(a,b){return null===a?b.state:b.state||a},all:function(a,b){return null===a?b.state:b.state&&a}};return{handlerFor:b}}),define("laxar-patterns/lib/i18n",["laxar"],function(a){"use strict";function b(b,c){function d(c){var d=c.locale,e=a.object.path(b,f).tags,h=e[d];h!==c.languageTag&&(e[d]=c.languageTag,g[d].forEach(function(a){a(c,h)}))}function e(){var c=a.object.path(b,f);c||(c={},a.object.setPath(b,f,c)),c.tags||(c.tags={})}var f=c||"i18n";e();var g={},h={registerLocale:function(a,c){var e=a;return Array.isArray(a)||(e=a?[a]:[]),e.forEach(function(a){g[a]||(g[a]=[],b.eventBus.subscribe("didChangeLocale."+a,d));var e=(c||{}).onChange;e&&(g[a]=g[a].concat(Array.isArray(e)?e:[e]))}),h},registerLocaleFromFeature:function(c,d){var e=a.object.path(b.features,c);return h.registerLocale(e.locale||e,d||{})},scopeLocaleFromFeature:function(c,d){var e=a.object.path(b.features,c);return b.i18n.locale=e.locale||e,h.registerLocale(b.i18n.locale,d||{})},localizer:function(c){function d(b){if("string"==typeof b)return b;var d=e.tags[e.locale];return d?a.i18n.localizer(d,c)(b):c}var e=a.object.path(b,f);return d.format=function(b,c){var d=a.i18n.localizer(e.tags[e.locale]);return d.format.apply(d,arguments)},d}};return h}return{handlerFor:b}}),define("laxar-patterns/lib/json",["laxar","json-patch"],function(a,b,c){"use strict";function d(a,b,d){for(var e=b.split("/"),f=e.length,g=-1!==b.indexOf("~"),h=1;f>h;++h){if(a===c)return d;if(Array.isArray(a)){var i=parseInt(e[h],10);a=a[i]}else{var j=e[h];g&&(j=j.replace(/~1/g,"/").replace(/~0/g,"~")),a=a[j]}}return a===c?d:a}function e(b,c,d){var e=f(c);return a.object.setPath(b,e,d)}function f(a){var b=a.split("/").slice(1);if(-1!==a.indexOf("~"))for(var c=b.length,d=0;c>d;++d)b[d]=b[d].replace(/~1/g,"/").replace(/~0/g,"~");return b.join(".")}function g(a){if(""===a)return"";var b=a.split(".");if(-1!==a.indexOf("/")||-1!==a.indexOf("~"))for(var c=b.length,d=0;c>d;++d)b[d]=b[d].replace(/~/g,"~0").replace(/\//g,"~1");return"/"+b.join("/")}function h(a,c){b.apply(a,c)}function i(a,c){return b.compare(a,c)}return{getPointer:d,setPointer:e,pointerToPath:f,pathToPointer:g,applyPatch:h,createPatch:i}}),define("laxar-patterns/lib/patches",["laxar"],function(a){"use strict";function b(b,c){if(Array.isArray(c)){var d=c;c={},d.forEach(function(a,b){"undefined"!=typeof a&&(c[b]=a)})}Object.keys(c).sort(function(a,b){return a.length-b.length}).forEach(function(d){a.object.setPath(b,d,c[d])})}function c(a,b){function c(a,b,d){var e;for(e in a)if(a.hasOwnProperty(e)&&("$"!==e.charAt(0)||"$"!==e.charAt(1))){var h=a[e],j=d.concat(e);null==b[e]?i[j.join(".")]=f(g(h)):h&&"object"==typeof h?c(h,b[e],j):h!==b[e]&&(i[j.join(".")]=h)}for(e in b)b.hasOwnProperty(e)&&(e in a||(i[d.concat(e).join(".")]=null))}var d=e(a),h=e(b);if("array"!==d&&"object"!==d)return null;if(d!==h)return g(a);var i={};return c(a,b,[]),i}function d(a,c){var d={},e=Object.keys(a),f=Object.keys(c);return e.forEach(function(b){for(var c=0;c<f.length;++c)if(b===f[c]||0===b.indexOf(f[c]+"."))return;d[b]=a[b]}),f.forEach(function(f){for(var g=0;g<e.length;++g){var h=e[g],i=h+".";if(0===f.indexOf(i)){var j={};j[f.replace(i,"")]=c[f];var k=a[h];return b(k,j),void(d[h]=k)}}d[f]=c[f]}),d}function e(a){if(null===a)return"null";if("undefined"==typeof a)return"undefined";var b=Object.prototype.toString.call(a).split(" ")[1];if(b)return b.substr(0,b.length-1).toLowerCase()}function f(a){if(null===a)return a;for(var b in a)a.hasOwnProperty(b)&&("$"===b.charAt(0)&&"$"===b.charAt(1)?delete a[b]:"object"==typeof a[b]&&f(a[b]));return a}var g=a.object.deepClone;return{apply:b,create:c,merge:d}}),define("laxar-patterns/lib/resources",["laxar","json-patch"],function(a,b){"use strict";function c(a,b){p(a).hasType(Object).isNotNull(),p(b).hasType(String).isNotNull();var c=m(a);return function(a){return null==c[b]&&null==a.data?!1:(c[b]=a.data,!0)}}function d(a,c){p(a).hasType(Object).isNotNull(),p(c).hasType(String).isNotNull();var d=m(a);return function(a){return null!=d[c]&&Array.isArray(a.patches)?(b.apply(d[c],a.patches),!0):!1}}function e(b,c,d){p(b).hasType(Object).isNotNull(),p(b.eventBus).hasType(Object).isNotNull();var e=a.object.options(d,{deliverToSender:!1}),f=a.object.path(b.features,c+".resource");return!f&&e.isOptional?function(){return o().when()}:(p(f).hasType(String).isNotNull(),function(a){return b.eventBus.publish("didReplace."+f,{resource:f,data:a},{deliverToSender:!!e.deliverToSender})})}function f(c,d,e){p(c).hasType(Object).isNotNull(),p(c.eventBus).hasType(Object).isNotNull();var f=a.object.options(e,{deliverToSender:!1}),g=a.object.path(c.features,d+".resource");if(!g&&f.isOptional){var h=function(){return o().when()};return h.compareAndPublish=function(){return h()},h}p(g).hasType(String).isNotNull();var i=function(b){return p(b).hasType(Array).isNotNull(),b&&b.length?c.eventBus.publish("didUpdate."+g,{resource:g,patches:b},{deliverToSender:!!f.deliverToSender}):(a.log.trace('updatePublisher: Not sending empty didUpdate to resource "[0]" from sender "[1]".',g,(c.widget||{id:"unknown"}).id),o().when())};return i.compareAndPublish=function(a,c){var d=b.compare(a,c);return i(d)},i}function g(a){return new h(a)}function h(a){this.context_=a,this.externalHandlers_={},this.modelHandlers_={},this.waitingFor_=[],this.allReplacedCallback_=function(){}}function i(a,b,c){function d(b){var c=!0;return function(){return c?void(c=!1):b.apply(a,arguments)}}a.externalHandlers_[b]||(a.externalHandlers_[b]={onReplace:[],onUpdate:[]}),l(a.externalHandlers_[b].onUpdate,c.onUpdate),l(a.externalHandlers_[b].onUpdate,c.onUpdateReplace);var e=[];l(e,c.onReplace),l(e,c.onUpdateReplace),c.omitFirstReplace&&(e=e.map(function(a){return d(a)})),l(a.externalHandlers_[b].onReplace,e)}function j(a,b,d){var e=c(a.context_,d.modelKey);return a.modelHandlers_[b].onReplace?void a.modelHandlers_[b].onReplace.push(e):(a.modelHandlers_[b].onReplace=[e],void a.context_.eventBus.subscribe("didReplace."+b,function(c,d){var e=a.modelHandlers_[b].onReplace.reduce(function(a,b){return b(c,d)||a},!1);if(e)try{a.externalHandlers_[b].onReplace.forEach(function(a){a(c,d)})}finally{a.waitingFor_=a.waitingFor_.filter(function(a){return a!==b}),a.waitingFor_.length||a.allReplacedCallback_()}}))}function k(a,b,c){var e=d(a.context_,c.modelKey);return a.modelHandlers_[b].onUpdate?void a.modelHandlers_[b].onUpdate.push(e):(a.modelHandlers_[b].onUpdate=[e],void a.context_.eventBus.subscribe("didUpdate."+b,function(c,d){var e=a.modelHandlers_[b].onUpdate.reduce(function(a,b){return b(c,d)||a},!1);if(e)try{a.externalHandlers_[b].onUpdate.forEach(function(a){a(c,d)})}finally{a.waitingFor_.length||a.allReplacedCallback_()}}))}function l(a,b){return"function"==typeof b?void a.push(b):void(Array.isArray(b)&&Array.prototype.push.apply(a,b))}function m(a){return a.hasOwnProperty("resources")&&"object"==typeof a.resources||(a.resources={}),a.resources}function n(b,c,d){if(null==b||null==c)return!1;for(var e=0,f=0;f<d.length;++f){var g=d[f];if(-1!==g.indexOf(".")){var h=a.object.path(b,g),i=a.object.path(c,g);if(void 0===h&&void 0===i)continue;if(h!==i)return!1;++e}else{if(!(g in b||g in c))continue;if(b[g]!==c[g])return!1;++e}}return e>0}function o(){return a._tooling.provideQ()}var p=a.assert;return h.prototype.registerResourceFromFeature=function(b,c){var d=a.object.path(this.context_.features,b+".resource",null),e=a.object.options(c,{isOptional:!1});return null===d&&e.isOptional?this:(p(d).isNotNull('Could not find resource configuration in features for "'+b+'"'),e.modelKey||(e.modelKey=b.substr(b.lastIndexOf(".")+1)),this.registerResource(d,e))},h.prototype.registerResource=function(b,c){p(b).hasType(String).isNotNull();var d=a.object.options(c,{omitFirstReplace:!1,modelKey:b});return this.waitingFor_.push(b),i(this,b,d),b in this.modelHandlers_||(this.modelHandlers_[b]={}),j(this,b,d),k(this,b,d),this},h.prototype.whenAllWereReplaced=function(a,b){function c(){a(),a=function(){}}return p(a).hasType(Function).isNotNull(),this.allReplacedCallback_=b&&b.watch?a:c,this},h.prototype.wereAllReplaced=function(){return!this.waitingFor_.length},{replaceHandler:c,updateHandler:d,replacePublisherForFeature:e,updatePublisherForFeature:f,isSame:n,handlerFor:g}}),define("laxar-patterns/lib/validation",["laxar"],function(a){"use strict";function b(a,b){return e(a,f(b,arguments),"SUCCESS")}function c(a,b){return e(a,f(b,arguments),"ERROR")}function d(d){function e(b,c,e){a.assert(b).hasType(String).isNotNull(),a.assert(c).hasType(Function).isNotNull();var g=a.object.options(e,{isOptional:!1}),h=a.object.path(d.features,b+".resource",null);return null===h&&g.isOptional?k:(a.assert(h).isNotNull('Could not find resource configuration in features for "'+b+'"'),f(h,c))}function f(b,c){return a.assert(b).hasType(String).isNotNull(),a.assert(c).hasType(Function).isNotNull(),j.subscribe("validateRequest."+b,function(a,d){h(b,c.bind(null,a,d))}),k}function h(a,d){j.publish("willValidate."+a,{resource:a});try{var e=d();g().when(e).then(function(d){var e=Array.isArray(d)?d:d?[d]:null,f=e&&e.length>0?c(a,e):b(a);j.publish("didValidate."+a+"."+f.outcome,f)})["catch"](i.bind(null,a))}catch(f){i(a,f)}}function i(b,d){var e=d&&d.message?d.message:d;a.log.error('Error handling validateRequest for resource "[0]": [1]',b,e),d&&a.log.error("Stacktrace for previous error: [0]",d.stack||"unavailable");var f=a.configuration.get("lib.laxar-patterns.validation.i18nHtmlExceptionMessage","");j.publish("didValidate."+b+".ERROR",c(b,f))}a.assert(d).hasType(Object).hasProperty("eventBus");var j=d.eventBus,k={registerResourceFromFeature:e,registerResource:f};return k}function e(a,b,c){var d=[];return b&&b.length&&(d=b.map(function(a){return a.htmlMessage&&a.level?a:{htmlMessage:a,level:"ERROR"}})),{resource:a,data:d,outcome:c}}function f(a,b){return Array.isArray(a)?a:[].slice.call(b,1)}function g(){return a._tooling.provideQ()}return{successEvent:b,errorEvent:c,handlerFor:d}}),define("laxar-patterns/lib/visibility",["laxar"],function(a){"use strict";function b(a,b){return new c(a,b)}function c(b,c){this.scope_=b,b.isVisible=!1;var e=a.object.options(c,{});if(e.onAnyAreaRequest){var f=["changeAreaVisibilityRequest",b.widget.id].join(".");b.eventBus.subscribe(f,d(this,e.onAnyAreaRequest))}var g=["didChangeAreaVisibility",b.widget.area].join(".");b.eventBus.subscribe(g,function(a){var c=b.isVisible||!1;b.isVisible=a.visible,c!==a.visible&&(e.onChange&&e.onChange(a),e.onShow&&a.visible?e.onShow(a):e.onHide&&!a.visible&&e.onHide(a))})}function d(a,b){return function(c){var d=b(c);if(d===!0||d===!1){var e=["didChangeAreaVisibility",c.area,d].join(".");a.scope_.eventBus.publish(e,{area:c.area,visible:d},{deliverToSender:!1})}}}function e(a){return function(b){var c=["changeWidgetVisibilityRequest",a.widget.id,b].join(".");return a.eventBus.publishAndGatherReplies(c,{widget:a.widget.id,visible:b},{deliverToSender:!1})}}function f(a,b){return function(c){var d=["changeAreaVisibilityRequest",b,c].join(".");return a.eventBus.publishAndGatherReplies(d,{area:b,visible:c},{deliverToSender:!1})}}return c.prototype.registerArea=function(b,c){var e=a.object.options(c,{});if(e.onRequest){var f=["changeAreaVisibilityRequest",b].join(".");this.scope_.eventBus.subscribe(f,d(this,e.onRequest))}return this},{handlerFor:b,requestPublisherForWidget:e,requestPublisherForArea:f}}),define("laxar-patterns/laxar-patterns",["./lib/actions","./lib/errors","./lib/flags","./lib/i18n","./lib/json","./lib/patches","./lib/resources","./lib/validation","./lib/visibility"],function(a,b,c,d,e,f,g,h,i){"use strict";return{actions:a,errors:b,flags:c,i18n:d,json:e,patches:f,resources:g,validation:h,visibility:i}}),define("laxar-patterns",["laxar-patterns/laxar-patterns"],function(a){return a});
//# sourceMappingURL=laxar-patterns.min.js.map